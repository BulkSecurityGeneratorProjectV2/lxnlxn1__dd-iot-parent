<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/materialdesignicons.min.css" rel="stylesheet">
    <link href="css/style.min.css" rel="stylesheet">

</head>
<body>
<!--头部信息-->
<header class="lyear-layout-header">

    <nav class="navbar navbar-default">
        <div class="topbar">

            <div class="topbar-left">
                <span>DREAMDECK IOT云平台</span>
            </div>
            <ul class="topbar-right nav-drawer" style="margin-left: 70%" id="menuList">


            </ul>
            <ul class="topbar-right">
                <li class="dropdown dropdown-profile">
                    <a href="javascript:void(0)" data-toggle="dropdown">
                        <img class="img-avatar img-avatar-48 m-r-10" src="" id="avatar"/>
                        <span id="user-name"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li><a href="lyear_pages_profile.html"><i class="mdi mdi-account"></i> 个人信息</a></li>
                        <li><a href="lyear_pages_edit_pwd.html"><i class="mdi mdi-lock-outline"></i> 修改密码</a></li>
                        <li><a href="javascript:void(0)"><i class="mdi mdi-delete"></i> 清空缓存</a></li>
                        <li class="divider"></li>
                        <li><a onclick="logout()"><i class="mdi mdi-logout-variant"></i> 退出登录</a></li>
                    </ul>

                </li>
            </ul>

        </div>
    </nav>

</header>
<!--End 头部信息-->
</body>
</html>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/localStorage.js"></script>
<script type="text/javascript">
    var data = localStorage.getItem('tocken');
    if (data !== null) {
        if (data.expirse != null && data.expirse < new Date().getTime()) {
            localStorage.removeItem(key);
        }
    }

    var obj = JSON.parse(data);

    var objs = JSON.parse(obj.value);

    function logout(obj) {
        $.ajax({
            type: "get",
            dataType: "json",
            url: "http://192.168.1.117:9999/auth/token/logout",
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", objs.access_token);
            },
            success: function (res) {
                var userinfo = JSON.parse(JSON.stringify(res));
            }
        })
    }

    $(function () {
        if (obj == null) {
            alert("登录已过期");
            location.href = "login.html";
        } else {
            $.ajax({
                type: "get",
                dataType: "json",
                url: "http://192.168.1.117:9999/admin/user/info",
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + objs.access_token);
                },
                success: function (res) {
                    var userinfo = JSON.parse(JSON.stringify(res));
                    sessionStorage.setItem("userInfo", JSON.stringify(res));
                    $("#avatar").attr("src", userinfo.data.sysUser.avatar);
                    $("#user-name").html(userinfo.data.sysUser.username + "<span class=\"caret\"></span>");
                }
            })
            $.ajax({
                type: "get",
                dataType: "json",
                url: "http://192.168.1.117:9999/admin/menu",
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + objs.access_token);
                },
                success: function (res) {
                    var tree = JSON.parse(JSON.stringify(res));
                    var html = "";
                    for (var i = 0; i < tree.data.length; i++) {
                        html += "<li class=\"nav-item nav-item-has-subnav\">\n" +
                            "                    <a href=" + res.data[i].path + ".html" + ">" + res.data[i].name + "</a>\n" +
                            "                </li>";

                    }
                    $("#menuList").html(html);

                }
            })
        }

    })
</script>