<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>项目添加</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/materialdesignicons.min.css" rel="stylesheet">
    <link href="css/style.min.css" rel="stylesheet">
    <link href="https://www.17sucai.com/preview/1/2017-08-21/bootstrap-fileinput/css/bootstrap-fileinput.css"
          rel="stylesheet">
</head>

<body>
<div class="lyear-layout-web">
    <div class="lyear-layout-container">
        <!--左侧导航-->
        <aside class="lyear-layout-sidebar">
            <!-- logo -->
            <div id="logo" class="sidebar-header">

            </div>
            <div class="lyear-layout-sidebar-scroll">

                <nav class="sidebar-main">
                    <ul class="nav nav-drawer" id="menuList">


                    </ul>
                </nav>

            </div>
        </aside>
        <!--End 左侧导航-->
        <!--页面主要内容-->
        <main class="lyear-layout-content">

            <div class="container-fluid">
                <div class="card">
                    <div class="card-toolbar clearfix">
                        <h2>用户添加</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="tab-content">
                            <form action="#!" method="post" name="edit-form" class="edit-form">
                                <div class="form-group">
                                    <label for="companyId">公司</label>
                                    <select class="combobox" id="companyId" name="companyId">
                                    </select>

                                </div>
                                <div class="form-group">
                                    <label for="projectFile">用户头像</label>
                                    <input type="file" class="form-control" name="projectFile" id="projectFile"/>

                                </div>
                                <div class="form-group">
                                    <label for="username">姓名</label>
                                    <input class="form-control" type="text" id="username" name="username" value=""
                                           placeholder="请输入用户姓名">

                                </div>
                                <div class="form-group">
                                    <label for="phone">手机号</label>
                                    <input class="form-control" id="phone" name="phone" placeholder="请输入用户手机号"></input>

                                </div>
                                <div class="form-group">
                                    <label for="password">密码</label>
                                    <input class="form-control" type="text" id="password" name="password" value=""
                                           placeholder="请输入用户密码">

                                </div>
                                <div class="form-group" id="roleList">
                                    <label for="password">角色</label>
                                </div>
                                <div class="form-group" id="projectList">
                                    <label for="password">项目</label>


                                </div>
                                <div class="form-group">
                                    <button type="button" id="uploadSubmit" class="btn btn-primary m-r-5">确 定</button>
                                    <button type="button" class="btn btn-default"
                                            onclick="javascript:history.back(-1);return false;">返 回
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>

        </main>
        <!--End 页面主要内容-->
    </div>
</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/url.js"></script>
<script type="text/javascript" src="js/localStorage.js"></script>
<script type="text/javascript" src="js/check.js"></script>
<script type="text/javascript"
        src="https://www.17sucai.com/preview/1/2017-08-21/bootstrap-fileinput/js/bootstrap-fileinput.js"></script>
<script>
    var data = foowwLocalStorage.get('tocken');
    var obj = JSON.parse(data);


    $('#uploadSubmit').click(function () {
        var formData = new FormData();
        var data = $('#projectFile')[0].files[0];
        var name = $('#projectFile').val();
        formData.append('fileImg', data);
        var chk_value = [];//定义一个数组
        var projectList = [];
        $('input[name="roleId"]:checked').each(function () {//遍历每一个名字为interest的复选框，其中选中的执行函数
            chk_value.push($(this).val());//将选中的值添加到数组chk_value中
        });
        $('input[name="projectId"]:checked').each(function () {//遍历每一个名字为interest的复选框，其中选中的执行函数
            projectList.push($(this).val());//将选中的值添加到数组chk_value中
        });
        $.ajax({
            url: GlobalConfig.IPSSAddress + 'iot/project/upload',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            mimeType: "multipart/form-data",
            success: function (res) {

                var res = JSON.parse(res);
                if (res.code == 0) {
                    var dataJson = {
                        "companyId": $('#companyId').val(),
                        "password": $('#password').val(),
                        "phone": $('#phone').val(),
                        "username": $('#username').val(),
                        "avatar": "http://192.168.1.117:9000/" + res.data.bucketName + "/" + res.data.fileName,
                        "role": chk_value,
                        "projectList": projectList
                    }
                    $.ajax({
                        url: GlobalConfig.IPSSAddress + 'admin/user',
                        type: 'POST',
                        dataType: "json",
                        beforeSend: function (XMLHttpRequest) {
                            XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj["access_token"]);
                        },
                        contentType: 'application/json;charset=utf-8',
                        data: JSON.stringify(dataJson),
                        success: function (data) {
                            alert("添加成功");
                            location.href = "userList.html";
                        },
                        error: function (data) {
                            alert("失败");
                        }
                    });

                }
            }
        })
    })

    $(function () {
        var data = foowwLocalStorage.get('tocken');
        var obj = JSON.parse(data);
        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/company/list",
            success: function (res) {
                console.log(res);
                var tree = JSON.parse(JSON.stringify(res));
                var html = "";
                for (var i = 0; i < tree.data.length; i++) {
                    console.log(tree.data[i].name);
                    html += "<option value=" + tree.data[i].deptId + ">" + tree.data[i].name + "</option>"
                }
                $("#companyId").html(html);

            }
        })
        $.ajax({
            type: "post",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "iot/project/list",
            success: function (res) {
                console.log(res);
                var tree = JSON.parse(JSON.stringify(res));
                var html = "";
                for (var i = 0; i < tree.data.length; i++) {
                    console.log(tree.data[i].name);

                    html += "<input type=\"checkbox\" value=" + tree.data[i].projetId + " name=\"projectId\"> " + tree.data[i].projectName
                }
                $("#projectList").html(html);

            }
        })
        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/role/list",
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj["access_token"]);
            },
            success: function (res) {
                console.log(res);
                var tree = JSON.parse(JSON.stringify(res));
                var html = "";
                for (var i = 0; i < tree.data.length; i++) {
                    html += "<input type=\"checkbox\" value=" + tree.data[i].roleId + " name=\"roleId\"> " + tree.data[i].roleName
                }
                $("#roleList").html(html);

            }
        })


        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/menu/tree",
            success: function (res) {
                console.log(res);
                var tree = JSON.parse(JSON.stringify(res));
                var html = "";
                for (var i = 0; i < tree.data.length; i++) {
                    if (tree.data[i].id == 2100) {
                        for (var k = 0; k < tree.data[i].children.length; k++) {
                            html += "<li class=\"nav-item  \" href=" + tree.data[i].children[k].path + ".html" + ">" +
                                "<a>" + tree.data[i].children[k].name + "</a>" +
                                "<ul class=\"nav nav-subnav\">\n" +
                                "</ul>" +
                                "</li>";
                        }

                    }


                }
                $("#menuList").html(html);

            }
        })
    })

    function getQueryString() {
        var obg = {}, a = '';
        (a = window.location.search.substr(1)) || (a = window.location.hash.split('?')[1])
        a.split(/&/g).forEach(function (item) {
            obg[(item = item.split('='))[0]] = item[1];
        })
        return obg
    }


</script>