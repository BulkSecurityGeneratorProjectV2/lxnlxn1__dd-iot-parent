<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>项目组</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/materialdesignicons.min.css" rel="stylesheet">
    <link href="css/style.min.css" rel="stylesheet">
</head>

<body>
<div class="lyear-layout-web">
    <div class="lyear-layout-container">
        <!--左侧导航-->
        <aside class="lyear-layout-sidebar">
            <!-- logo -->
            <div id="logo" class="sidebar-header">

            </div>
            <div class="lyear-layout-sidebar-scroll">

                <nav class="sidebar-main">
                    <ul class="nav nav-drawer" id="menuList">


                    </ul>
                </nav>

            </div>
        </aside>
        <!--End 左侧导航-->
        <!--页面主要内容-->
        <main class="lyear-layout-content">

            <div class="row">

                <div class="col-md-3">
                    <div class="card-header">
                        <h4>人员类别</h4>
                        <span type="button" class="mdi mdi-plus " data-toggle="modal" data-target="#myModal">
                    </span>
                    </div>

                    <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                            aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title" id="myModalLabel">修改角色</h4>
                                </div>
                                <div class="modal-body">
                                    <form action="#!" method="post">
                                        <div class="table-responsive">
                                            <div class="form-group">
                                                <label for="example-text-input">角色名称</label>
                                                <input class="form-control" type="text" name="roleNames"
                                                       placeholder="角色名称">
                                                <input class="form-control" type="hidden" name="roleId">
                                            </div>
                                            <table class="table table-striped">
                                                <thead>
                                                </thead>
                                                <tbody id="editRoleList">


                                                </tbody>
                                            </table>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                    <button type="button" class="btn btn-primary" onclick="editRole()">点击保存</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                            aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title" id="myModalLabel">添加角色</h4>
                                </div>
                                <div class="modal-body">
                                    <form action="#!" method="post">
                                        <div class="form-group">
                                            <label for="example-text-input">角色名称</label>
                                            <input class="form-control" type="text" name="roleName" placeholder="角色名称">
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                </thead>
                                                <tbody id="totalRoleList">


                                                </tbody>
                                            </table>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                    <button type="button" class="btn btn-primary" onclick="saveRole()">点击保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="roleList">

                            <!--                               <div class="example-box">-->
                            <!--                                   <span class="nav-item" onclick="roleClick()">111</span>-->
                            <!--                                   <span class="mdi mdi-lead-pencil" onclick="roleEdit()"></span>-->
                            <!--                                   <span class="mdi mdi-delete-empty " onclick="roleDelect()"></span>-->

                            <!--                               </div>-->

                        </div>
                    </div>

                </div>
                <div class="col-md-5" class="crad">
                    <div class="card-header">
                        <h4>勾选添加的人员</h4>
                        </label>
                    </div>
                    <div class="card">
                        <div class="card-body" id="userInfo">

                            <!--                            <div>-->
                            <!--                                <img class="img-avatar img-avatar-48 m-r-10" src="images/users/avatar.jpg" >-->
                            <!--                                <span>ces1</span>-->
                            <!--                                <span>111111</span>-->
                            <label class="lyear-checkbox checkbox-inline checkbox-primary">
                                <input type="checkbox" name="" checked>
                            </label>
                            <!--                            </div>-->
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!--End 页面主要内容-->
    </div>
</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/url.js"></script>
<script type="text/javascript" src="js/localStorage.js"></script>
<script type="text/javascript" src="js/check.js"></script>
<script>

    var projectId = sessionStorage.getItem('projectId');
    var objs = JSON.parse(projectId);

    function userAdd1(o) {
        console.log(o.value)
        var dataJson = {
            userList: o.value,
            projectId: objs
        }
        $.ajax({
            type: "post",
            dataType: "json",
            contentType: 'application/json;charset=utf-8',
            url: GlobalConfig.IPSSAddress + "iot/project/removeProjectTeam",
            data: JSON.stringify(dataJson),
            success: function (res) {
                console.log(res);
                location.href = "projectTeam.html"
            }
        })

    }

    function userAdd2(o) {
        console.log(o.value)
        var dataJson = {
            userList: o.value,
            projectId: objs
        }
        $.ajax({
            type: "post",
            dataType: "json",
            contentType: 'application/json;charset=utf-8',
            url: GlobalConfig.IPSSAddress + "iot/project/saveProjectTeam",
            data: JSON.stringify(dataJson),
            success: function (res) {
                console.log(res);
                location.href = "projectTeam.html"
            }
        })

    }

    function roleEdit(objs) {
        $('#myModal1').modal('show');
        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/menu/tree",
            success: function (res) {
                $.ajax({
                    type: "get",
                    dataType: "json",
                    url: GlobalConfig.IPSSAddress + "admin/menu/tree/" + objs.id,
                    success: function (result) {
                        $("input[name='roleNames']").val(objs.attributes.name.value);
                        $("input[name='roleId']").val(objs.id);
                        console.log(result);
                        var html = ""
                        for (var i = 0; i < res.data.length; i++) {
                            var a = "id-";
                            if (result.data.indexOf(res.data[i].id) > -1) {
                                html += " <tr>\n" +
                                    "                                                    <td>\n" +
                                    "                                                        <label class=\"lyear-checkbox checkbox-primary\">\n" +
                                    "                                                            <input name=\"rule[]\" type=\"checkbox\" checked=\"checked\" class=\"checkbox-parent\" dataid=" + a + res.data[i].id + " value=" + res.data[i].id + ">" +
                                    "                                                            <span> " + res.data[i].name + "</span>\n" +
                                    "                                                        </label>\n" +
                                    "                                                    </td>\n" +
                                    "                                                </tr>\n"
                            } else {
                                html += " <tr>\n" +
                                    "                                                    <td>\n" +
                                    "                                                        <label class=\"lyear-checkbox checkbox-primary\">\n" +
                                    "                                                            <input name=\"rule[]\" type=\"checkbox\" class=\"checkbox-parent\" dataid=" + a + res.data[i].id + " value=" + res.data[i].id + ">" +
                                    "                                                            <span> " + res.data[i].name + "</span>\n" +
                                    "                                                        </label>\n" +
                                    "                                                    </td>\n" +
                                    "                                                </tr>\n"
                            }

                            for (var k = 0; k < res.data[i].children.length; k++) {
                                if (result.data.indexOf(res.data[i].children[k].id) > -1) {
                                    html += "                                                <tr>\n" +
                                        "                                                    <td class=\"p-l-20\">\n" +
                                        "                                                        <label class=\"lyear-checkbox checkbox-primary\">\n" +
                                        "                                                            <input name=\"rule[]\" type=\"checkbox\" checked=\"checked\" class=\"checkbox-parent checkbox-child\"  dataid=" + a + res.data[i].id + "-" + res.data[i].children[k].id + " value=" + res.data[i].children[k].id + ">" +
                                        "                                                            <span> " + res.data[i].children[k].name + "</span>\n" +
                                        "                                                        </label>\n" +
                                        "                                                    </td>\n" +
                                        "                                                </tr>\n"
                                } else {
                                    html += "                                                <tr>\n" +
                                        "                                                    <td class=\"p-l-20\">\n" +
                                        "                                                        <label class=\"lyear-checkbox checkbox-primary\">\n" +
                                        "                                                            <input name=\"rule[]\" type=\"checkbox\" class=\"checkbox-parent checkbox-child\"  dataid=" + a + res.data[i].id + "-" + res.data[i].children[k].id + " value=" + res.data[i].children[k].id + ">" +
                                        "                                                            <span> " + res.data[i].children[k].name + "</span>\n" +
                                        "                                                        </label>\n" +
                                        "                                                    </td>\n" +
                                        "                                                </tr>\n"
                                }
                                for (var l = 0; l < res.data[i].children[k].children.length; l++) {
                                    if (result.data.indexOf(res.data[i].children[k].children[l].id) > -1) {
                                        html += "                                                <tr>\n" +
                                            "                                                    <td class=\"p-l-40\">\n" +
                                            "                                                        <label class=\"lyear-checkbox checkbox-primary checkbox-inline\">\n" +
                                            "                                                            <input name=\"rule[]\" type=\"checkbox\" checked=\"checked\"  class=\"checkbox-child\"  dataid=" + a + res.data[i].id + "-" + res.data[i].children[k] + "-" + res.data[i].children[k].children[l].id + " value=" + res.data[i].children[k].children[l].id + ">" +
                                            "                                                            <span> " + res.data[i].children[k].children[l].name + "</span>\n" +
                                            "                                                        </label>\n" +
                                            "                                                    </td>\n" +
                                            "                                                </tr>"
                                    } else {
                                        html += "                                                <tr>\n" +
                                            "                                                    <td class=\"p-l-40\">\n" +
                                            "                                                        <label class=\"lyear-checkbox checkbox-primary checkbox-inline\">\n" +
                                            "                                                            <input name=\"rule[]\" type=\"checkbox\" class=\"checkbox-child\"  dataid=" + a + res.data[i].id + "-" + res.data[i].children[k] + "-" + res.data[i].children[k].children[l].id + " value=" + res.data[i].children[k].children[l].id + ">" +
                                            "                                                            <span> " + res.data[i].children[k].children[l].name + "</span>\n" +
                                            "                                                        </label>\n" +
                                            "                                                    </td>\n" +
                                            "                                                </tr>"
                                    }

                                }
                            }
                            $("#editRoleList").html(html);
                        }
                    }
                })

            }
        })
    }

    function roleDelect(objs) {
        console.log(objs.id);

        var msg = "您真的确定要删除吗？\n\n请确认！";
        if (confirm(msg) == true) {
            $.ajax({
                type: "delete",
                dataType: "json",
                url: GlobalConfig.IPSSAddress + "admin/role/" + objs.id,
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj.access_token);
                },
                success: function (res) {
                    console.log(res);
                    location.href = "projectTeam.html"
                }
            })
        } else {
            return false;
        }

    }

    function editRole() {
        console.log($("input[name='roleId']").val());
        var str = "";
        $("input[name='rule[]']:checked").each(function (index, item) {
            if ($("input[name='rule[]']:checked").length - 1 == index) {
                str += $(this).val();
            } else {
                str += $(this).val() + ",";
            }
        });
        console.log(str);
        $.ajax({
            type: "put",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/role/menu",
            data: {
                "roleId": $("input[name='roleId']").val(),
                "menuIds": str,
            },
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj.access_token);
            },
            success: function (res) {

                console.log(res);
                location.href = "projectTeam.html";
            }
        })

    }

    function saveRole() {
        console.log();
        var str = "";
        $("input[name='rules[]']:checked").each(function (index, item) {

            if ($("input[name='rules[]']:checked").length - 1 == index) {
                str += $(this).val();
            } else {
                str += $(this).val() + ",";
            }
        });
        console.log(str);
        var dataJson = {}
        $.ajax({
            type: "post",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/role",
            data: {
                "roleName": $("[name='roleName']").val(),
                "roleCode": "ROLE_MONEY",
                "dsType": 2,
                "menuIds": str
            },
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj.access_token);
            },
            success: function (res) {
                console.log(res);
            }
        })


    }

    function hrefIndex() {
        location.href = "index.html";
    }

    var data = foowwLocalStorage.get('tocken');
    var obj = JSON.parse(data);
    console.log(obj);

    function roleClick(res) {
        var url = ""
        if (res == 0) {
            url = GlobalConfig.IPSSAddress + "admin/role/userRoleList?roleId=" + res
        } else {
            url = GlobalConfig.IPSSAddress + "admin/role/userRoleList?roleId=" + res.id;
        }
        $.ajax({
            type: "post",
            dataType: "json",
            url: url,
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj.access_token);
            },
            success: function (res) {
                console.log(res);
                html = "";
                for (var i = 0; i < res.data.length; i++) {
                    html += "<div>\n" +
                        "<img class=\"img-avatar img-avatar-48 m-r-10\" src=" + res.data[i].avatar + " >\n" +
                        "<span>" + res.data[i].username + "</span>\n" +
                        "<span>" + res.data[i].phone + "</span>\n"
                    var list = new Array();
                    for (var k = 0; k < userList.data.length; k++) {
                        list.push(userList.data[k].userId);
                    }
                    if (list.indexOf(res.data[i].userId) > -1) {
                        html += "<input type=\"checkbox\" id=\"userId\"  onclick=\"userAdd1(this)\" value=" + res.data[i].userId + " checked>"
                    } else {
                        html += "<input type=\"checkbox\" id=\"userId\" onclick=\"userAdd2(this)\" value=" + res.data[i].userId + ">"
                    }

                    +"  </div>"
                }
                $("#userInfo").html(html);

            }
        })
    }

    var userList;
    $(function () {
        roleClick(0);
        var projectId = sessionStorage.getItem('projectId');
        var objs = JSON.parse(projectId);
        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/menu/tree",
            success: function (res) {
                console.log(res);
                var tree = JSON.parse(JSON.stringify(res));
                var html = "";
                for (var i = 0; i < tree.data.length; i++) {
                    if (tree.data[i].id == 2000) {
                        for (var k = 0; k < tree.data[i].children.length; k++) {
                            html += "<li class=\"nav-item  \" >" +
                                "<a href=" + tree.data[i].children[k].path + ".html" + ">" + tree.data[i].children[k].name + "</a>" +
                                "<ul class=\"nav nav-subnav\">\n" +
                                "</ul>" +
                                "</li>";
                        }

                    }


                }
                $("#menuList").html(html);

            }
        })
        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "iot/project/projectInfo",
            data: {
                "projectId": objs,
            },
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj.access_token);
            },
            success: function (res) {
                $("#logo").html(" <h2 onclick='hrefIndex()' style=\"text-align: center\">←" + res.data.projectName + "</h2>");
            }
        });

        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "iot/project/getProjectUserList?projectId=" + objs,
            success: function (res) {
                userList = res;
            }
        })
        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/role/list",
            beforeSend: function (XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("Authorization", "Bearer " + obj.access_token);
            },
            success: function (res) {
                console.log(res);
                html = ""
                for (var i = 0; i < res.data.length; i++) {
                    html += "<div class=\"example-box\">\n" +
                        "<span class=\"nav-item\" onclick=\"roleClick(this)\" id=" + res.data[i].roleId + ">" + res.data[i].roleName + "</span>\n" +
                        "<span class=\"mdi mdi-lead-pencil\" onclick=\"roleEdit(this)\" id=" + res.data[i].roleId + " name=" + res.data[i].roleName + "></span>\n" +
                        "<span class=\"mdi mdi-delete-empty \" onclick=\"roleDelect(this)\" id=" + res.data[i].roleId + "></span>\n" +
                        "\n" +
                        "</div>\n";
                }
                $("#roleList").html(html);
            }
        })
        $.ajax({
            type: "get",
            dataType: "json",
            url: GlobalConfig.IPSSAddress + "admin/menu/tree",
            success: function (res) {
                console.log(res);
                var html = ""
                for (var i = 0; i < res.data.length; i++) {
                    var a = "id-";
                    html += " <tr>\n" +
                        "                                                    <td>\n" +
                        "                                                        <label class=\"lyear-checkbox checkbox-primary\">\n" +
                        "                                                            <input name=\"rules[]\" type=\"checkbox\" class=\"checkbox-parent\" dataid=" + a + res.data[i].id + " value=" + res.data[i].id + ">" +
                        "                                                            <span> " + res.data[i].name + "</span>\n" +
                        "                                                        </label>\n" +
                        "                                                    </td>\n" +
                        "                                                </tr>\n"
                    for (var k = 0; k < res.data[i].children.length; k++) {
                        html += "                                                <tr>\n" +
                            "                                                    <td class=\"p-l-20\">\n" +
                            "                                                        <label class=\"lyear-checkbox checkbox-primary\">\n" +
                            "                                                            <input name=\"rules[]\" type=\"checkbox\" class=\"checkbox-parent checkbox-child\"  dataid=" + a + res.data[i].id + "-" + res.data[i].children[k].id + " value=" + res.data[i].children[k].id + ">" +
                            "                                                            <span> " + res.data[i].children[k].name + "</span>\n" +
                            "                                                        </label>\n" +
                            "                                                    </td>\n" +
                            "                                                </tr>\n"
                        for (var l = 0; l < res.data[i].children[k].children.length; l++) {
                            html += "                                                <tr>\n" +
                                "                                                    <td class=\"p-l-40\">\n" +
                                "                                                        <label class=\"lyear-checkbox checkbox-primary checkbox-inline\">\n" +
                                "                                                            <input name=\"rules[]\" type=\"checkbox\" class=\"checkbox-child\"  dataid=" + a + res.data[i].id + "-" + res.data[i].children[k] + "-" + res.data[i].children[k].children[l].id + " value=" + res.data[i].children[k].children[l].id + ">" +
                                "                                                            <span> " + res.data[i].children[k].children[l].name + "</span>\n" +
                                "                                                        </label>\n" +
                                "                                                    </td>\n" +
                                "                                                </tr>"
                        }
                    }
                }
                $("#totalRoleList").html(html);
            }
        })

    })

    function getQueryString() {
        var obg = {}, a = '';
        (a = window.location.search.substr(1)) || (a = window.location.hash.split('?')[1])
        a.split(/&/g).forEach(function (item) {
            obg[(item = item.split('='))[0]] = item[1];
        })
        return obg
    }


</script>